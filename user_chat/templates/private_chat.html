{% extends 'base.html' %}
{% load static %}
{% load user_tags %}
{% load chat_tags %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
    <div class="chat_content_grid">
        <div class="chat_content_grid_cell_companion_data">
            {% if request.user != chat.member_1 %}
                    <a href="{% url 'user_page' user_id=chat.member_1.user_id %}">
                        <img src="
                        {% if chat.member_1.profile_picture %}
                            {{ chat.member_1.profile_picture.url }}
                        {% else %}
                            {% static 'icons/user_icon.png' %}
                        {% endif %}
                        " alt="" height="40px" width="40px" class="preview_picture">
                    </a>
                <a href="{% url 'user_page' user_id=chat.member_1.user_id %}">
                    {{ chat.member_1.first_name }} {{ chat.member_1.last_name }}
                </a>
            {% else %}
                <div><a href="{% url 'user_page' user_id=chat.member_2.user_id %}">
                    <img src="
                    {% if chat.member_2.profile_picture %}
                        {{ chat.member_2.profile_picture.url }}
                    {% else %}
                        {% static 'icons/user_icon.png' %}
                    {% endif %}
                    " alt="" height="40px" width="40px" class="preview_picture">
                </a></div>
                <div><a href="{% url 'user_page' user_id=chat.member_2.user_id %}">
                    {{ chat.member_2.first_name }} {{ chat.member_2.last_name }}
                </a></div>
            {% endif %}
        </div>
        <div class="chat_content_grid_cell_messages">
            {% if chat.messages.all %}
                {% for message in chat.messages.all %}
                    {% if message.sender == request.user %}
                        {% current_user_message_tag message=message chat=chat %}
                    {% else %}
                        {% other_user_message_tag message=message chat=chat %}
                    {% endif %}
                {% endfor %}
            {% else %}
                No messages yet
            {% endif %}
        </div>
        <div class="chat_content_grid_cell_write_message">
            {% form_tag form=form type='message' %}
        </div>
    </div>
{% endblock %}

{% block javascript %}
    <script>
        $(document).ready(function () {
            // WebSocket initialization
            const chatSocket = new WebSocket(
                `ws://${window.location.host}/chats/private_chat/{{ chat.chat_id }}/`
            )
            // When getting message from server
            chatSocket.onmessage = function(event) {
                let data = JSON.parse(event.data)
                // If deleting
                if (data.mode === 'delete') {
                    $(`.message_${data.message_id}_delete_icon`).parent().parent().parent().
                    parent().parent().remove()
                    if ($('.chat_current_user_message').length === 0 &&
                        $('.chat_other_user_message').length === 0) {
                        $('.chat_content_grid_cell_messages').text('No messages yet')
                    }
                // If updating
                } else if (data.mode === 'edit') {
                    $('.edit_form').parent().parent().replaceWith(data.message_html)
                    $(`.message_${data.message_id}_delete_icon`).parent().parent().
                    parent().parent().parent().replaceWith(data.message_html)
                // If creating
                } else if (data.mode === 'send') {
                    let messages_grid = $('.chat_content_grid_cell_messages')
                    if('No messages yet' === messages_grid[0].innerText) {
                        messages_grid.text('')
                    }
                    messages_grid.append(data.message_html)
                }
            }
            // Form data serialization
            function getFormData(form) {
                var unindexed_array = form.serializeArray();
                var indexed_array = {};
                $.map(unindexed_array, function (n, i) {
                    indexed_array[n['name']] = n['value'];
                });
                return indexed_array;
            }
            // Send message
            $('.chat_content_grid_cell_write_message').on('submit', '.form', function (event) {
                event.preventDefault()
                let data = getFormData($(this))
                data['user_id'] = '{{ request.user.user_id }}'
                data['chat_id'] = '{{ chat.chat_id }}'
                data['mode'] = 'send'
                chatSocket.send(JSON.stringify(data))
                $(this).trigger('reset')
            })
            // Delete message
            $('.chat_content_grid_cell_messages').on('click', 'img[class$="_delete_icon"]', function (){
                const re = /^message_([\w]+)_delete_icon$/
                chatSocket.send(JSON.stringify({
                    "mode": "delete",
                    "message_id": $(this).attr('class').match(re)[1],
                    "chat_id": '{{ chat.chat_id }}',
                }))
            })
            // Update message
            $('.chat_content_grid_cell_messages').on('submit', '.edit_form', function (event) {
                event.preventDefault()
                const message_id = $('#note_id').attr('name')
                $('#note_id').remove()
                let data = getFormData($(this))
                data["mode"] = "edit"
                data["message_id"] = message_id
                data["chat_id"] = '{{ chat.chat_id }}'
                chatSocket.send(JSON.stringify(data))
            })
        })
    </script>
{% endblock %}